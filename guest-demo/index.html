<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ</title>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#ffffff">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="mobile-web-app-capable" content="yes">

  <script src="qr-scanner.umd.min.js"></script>
  <style>
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      font-family: Arial, sans-serif;
      margin: 0;
      position: relative;
      overflow: hidden; /* –°–∫—Ä—ã–≤–∞–µ–º –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ */
    }

    #video-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden; /* –°–∫—Ä—ã–≤–∞–µ–º –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ */
    }

    #video-container.example-style-1 .scan-region-highlight-svg,
    #video-container.example-style-1 .code-outline-highlight {
      stroke: #64a2f3 !important;
    }

    video {
      width: 100%; /* –®–∏—Ä–∏–Ω–∞ 100% */
      height: 100%; /* –í—ã—Å–æ—Ç–∞ 100% */
      object-fit: cover; /* –ó–∞–ø–æ–ª–Ω—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, —Å–æ—Ö—Ä–∞–Ω—è—è —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Å—Ç–æ—Ä–æ–Ω */
      border: none;
    }

    #result-card {
      display: none;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
      text-align: center;
      font-size: 2em;
      z-index: 20;
    }
    .ok {
      color: green;
    }
    .repeat {
      color: darkorange;
    }
    .deny {
      color: red;
    }
    #continue-button {
      margin-top: 20px;
      padding: 10px 20px;
      font-size: 1em;
      cursor: pointer;
    }

    /* –°—Ç–∏–ª—å –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Ñ–æ–Ω–∞—Ä–∏–∫–∞ */
    #flashlight-button {
      position: absolute;
      bottom: 20px;
      left: 20px;
      background-color: rgba(255, 255, 255, 0.8);
      border: none;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      cursor: pointer;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
  </style>
</head>
<body>

<div id="video-container" class="example-style-1">
  <video id="qr-video"></video>
</div>
<div id="result-card">
  <div id="result-message"></div>
  <button id="continue-button">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
</div>

<!-- –ö–Ω–æ–ø–∫–∞ —Ñ–æ–Ω–∞—Ä–∏–∫–∞ -->
<button id="flashlight-button" onclick="toggleFlashlight();">üî¶</button>

<script>
  let qrScanner;
  let scanning = true; // –§–ª–∞–≥ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è

  function toggleFlashlight()
  {
    qrScanner.toggleFlash();
  }

  document.addEventListener('DOMContentLoaded', () => {
    const video = document.getElementById('qr-video');
    const resultCard = document.getElementById('result-card');
    const resultMessage = document.getElementById('result-message');
    const continueButton = document.getElementById('continue-button');

    function startScanner() {
      qrScanner = new QrScanner(
              video,
              result => {
                if (scanning) { // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Ä–∞–∑—Ä–µ—à–µ–Ω–æ –ª–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
                  handleScan(result);
                }
              },
              // {
              //   highlightScanRegion: true,
              //   highlightCodeOutline: true,
              //   calculateScanRegion: (v) => {
              //     const smallestDimension = Math.min(v.videoWidth, v.videoHeight);
              //
              //     const scanRegionSize = Math.round(1 / 4 * smallestDimension);
              //
              //     return {
              //       x: Math.round((v.videoWidth - scanRegionSize) / 2),
              //       y: Math.round((v.videoHeight - scanRegionSize) / 2),
              //       width: scanRegionSize,
              //       height: scanRegionSize,
              //     };
              //   }
              // }
      );
      qrScanner.setInversionMode('both');
      qrScanner.start();
      qrScanner._updateOverlay();
    }

    async function requestCameraAccess() {
      try {
        const constraints = {
          video: {
            facingMode: { exact: "environment" } // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–¥–Ω—é—é –∫–∞–º–µ—Ä—É
          }
        };

        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;
        startScanner();
      } catch (error) {
        alert('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ: ' + error.message);
      }
    }

    async function checkCameraAccess() {
      const devices = await navigator.mediaDevices.enumerateDevices();
      const hasCamera = devices.some(device => device.kind === 'videoinput');

      if (hasCamera) {
        requestCameraAccess();
      } else {
        alert('–ö–∞–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.');
      }
    }

    async function getStatus(id) {
      const encodedId = encodeURIComponent(id);
      const url = `http://84.201.178.161:9976/check/${encodedId}`;

      try {
        const response = await fetch(url);

        if (!response.ok) {
          console.error(`HTTP error! status: ${response.status}`);
          return "ERROR"
        }

        const data = await response.json();
        return data.status;

      } catch (error) {
        console.error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ API: ${error}`);
        return 'ERROR'
      }
    }

    function handleScan(result) {
      // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∫–∞–Ω–µ—Ä
      scanning = false;

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω—É–∂–Ω–æ–º—É —Ñ–æ—Ä–º–∞—Ç—É
      const regex = /^(.*?)#PBD10#(.+)$/;
      const match = result.match(regex);

      if (match) {
        const id = result;
        getStatus(id).then(status => {
          const statusMap = {
            'OK': { message: '–û–ö', type: 'ok' },
            'RETRY': { message: '–£–ñ–ï –ü–†–û–•–û–î–ò–õ', type: 'repeat' },
            'NOT_FOUND': { message: '–ù–ï–¢ –í –°–ü–ò–°–ö–ï', type: 'deny' },
            'ERROR': { message: '–û–®–ò–ë–ö–ê –û–ë–†–ê–ë–û–¢–ö–ò', type: 'deny' }
          };

          const result = statusMap[status];
          if (result) {
            showResult(result.message, result.type);
          } else {
            showResult('–ù–ï–ò–ó–í–ï–°–¢–ù–ê–Ø –û–®–ò–ë–ö–ê', 'deny');
          }
        });
      } else {
        // –ï—Å–ª–∏ –∫–æ–¥ –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ñ–æ—Ä–º–∞—Ç—É
        showResult('QR-–ö–û–î –ù–ï–ö–û–†–†–ï–ö–¢–ù–´–ô', 'deny');
      }
    }

    function showResult(message, status) {
      resultMessage.textContent = message;
      resultMessage.className = status; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–ª–∞—Å—Å –¥–ª—è —Ü–≤–µ—Ç–∞ —Ç–µ–∫—Å—Ç–∞
      resultCard.style.display = 'block'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
    }

    continueButton.addEventListener('click', () => {
      resultCard.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
      scanning = true;
    });

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    checkCameraAccess();
  });
</script>

</body>
</html>

