<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Мероприятие</title>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#ffffff">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="mobile-web-app-capable" content="yes">

  <script src="qr-scanner.umd.min.js"></script>
  <style>
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      font-family: Arial, sans-serif;
      margin: 0;
      position: relative;
      overflow: hidden; /* Скрываем переполнение */
    }

    #video-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden; /* Скрываем переполнение */
    }

    #video-container.example-style-1 .scan-region-highlight-svg,
    #video-container.example-style-1 .code-outline-highlight {
      stroke: #64a2f3 !important;
    }

    video {
      width: 100%; /* Ширина 100% */
      height: 100%; /* Высота 100% */
      object-fit: cover; /* Заполняем контейнер, сохраняя соотношение сторон */
      border: none;
    }

    #result-card {
      display: none;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
      text-align: center;
      font-size: 2em;
      z-index: 20;
    }
    .ok {
      color: green;
    }
    .repeat {
      color: darkorange;
    }
    .deny {
      color: red;
    }
    #continue-button {
      margin-top: 20px;
      padding: 10px 20px;
      font-size: 1em;
      cursor: pointer;
    }
  </style>
</head>
<body>

<div id="video-container" class="example-style-1">
  <video id="qr-video"></video>
</div>
<div id="result-card">
  <div id="result-message"></div>
  <button id="continue-button">Продолжить</button>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const video = document.getElementById('qr-video');
    const resultCard = document.getElementById('result-card');
    const resultMessage = document.getElementById('result-message');
    const continueButton = document.getElementById('continue-button');

    const initialCodes = [
      { id: '001#PBD10#645KWR', name: 'Иванов Иван Иванович', activated: false },
      { id: '002#PBD10#H1VYJM', name: 'Петров Петр Петрович', activated: false },
      { id: '003#PBD10#5E5NBY', name: 'Сидоров Сидор Сидорович', activated: false },
      { id: '004#PBD10#9T8UZ2', name: 'Александров Александр Александрович', activated: false },
      { id: '005#PBD10#VH5J0Y', name: 'Васильев Василий Васильевич', activated: false },
      { id: '006#PBD10#QZ8Q4Z', name: 'Алексеев Алексей Алексеевич', activated: false },
      { id: '007#PBD10#Z6XJ0N', name: 'Дмитриев Дмитрий Дмитриевич', activated: false },
      { id: '008#PBD10#2Z7ZJ2', name: 'Ильин Илья Ильич', activated: false },
      { id: '009#PBD10#6V6JQW', name: 'Павлов Павел Павлович', activated: false },
      { id: '010#PBD10#Z2JZ2W', name: 'Сергеев Сергей Сергеевич', activated: false },
    ];

    let qrScanner;
    let scanning = true; // Флаг для отслеживания состояния сканирования

    function startScanner() {
      qrScanner = new QrScanner(
              video,
              result => {
                if (scanning) { // Проверяем, разрешено ли сканирование
                  handleScan(result);
                }
              },
              // {
              //   highlightScanRegion: true,
              //   highlightCodeOutline: true,
              //   calculateScanRegion: (v) => {
              //     const smallestDimension = Math.min(v.videoWidth, v.videoHeight);
              //
              //     const scanRegionSize = Math.round(1 / 4 * smallestDimension);
              //
              //     return {
              //       x: Math.round((v.videoWidth - scanRegionSize) / 2),
              //       y: Math.round((v.videoHeight - scanRegionSize) / 2),
              //       width: scanRegionSize,
              //       height: scanRegionSize,
              //     };
              //   }
              // }
      );
      qrScanner.start();
      qrScanner._updateOverlay();
    }

    async function requestCameraAccess() {
      try {
        const constraints = {
          video: {
            facingMode: { exact: "environment" } // Используем заднюю камеру
          }
        };

        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;
        startScanner();
      } catch (error) {
        alert('Ошибка доступа к камере: ' + error.message);
      }
    }

    async function checkCameraAccess() {
      const devices = await navigator.mediaDevices.enumerateDevices();
      const hasCamera = devices.some(device => device.kind === 'videoinput');

      if (hasCamera) {
        requestCameraAccess();
      } else {
        alert('Камера не найдена.');
      }
    }

    function handleScan(result) {
      // Останавливаем сканер
      scanning = false;

      // Проверяем, соответствует ли результат нужному формату
      const regex = /^(.*?)#PBD10#(.+)$/;
      const match = result.match(regex);

      if (match) {
        const id = result;
        const codeEntry = initialCodes.find(code => code.id === id);

        if (codeEntry) {
          if (!codeEntry.activated) {
            // Код найден и не активирован
            codeEntry.activated = true; // Активируем код
            showResult('ОК', 'ok');
          } else {
            // Код уже активирован
            showResult('УЖЕ ПРОХОДИЛ', 'repeat');
          }
        } else {
          // Код не найден в списке
          showResult('НЕТ В СПИСКЕ', 'deny');
        }
      } else {
        // Если код не соответствует формату
        showResult('QR-КОД НЕКОРРЕКТНЫЙ', 'deny');
      }
    }

    function showResult(message, status) {
      resultMessage.textContent = message;
      resultMessage.className = status; // Устанавливаем класс для цвета текста
      resultCard.style.display = 'block'; // Показываем карточку результата
    }

    continueButton.addEventListener('click', () => {
      resultCard.style.display = 'none'; // Скрываем карточку результата
      scanning = true;
    });

    // Проверяем доступ к камере при загрузке страницы
    checkCameraAccess();
  });
</script>

</body>
</html>

